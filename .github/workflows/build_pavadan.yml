name: build_pavadan

on:
  watch:
    types: [started]
#  push:
#    branches: [ master ]
#  pull_request:
#    branches: [ master ]
   
env:
  repo_url: https://github.com/hanwckf/rt-n56u
  repo_branch: v2019-03-07 # master
  repo_os: pavanda
  config: PSG1218.config
  model: PSG1218
  TZ: Asia/Shanghai
  wetransfer: false
  release: true
  pack7z: true
  zip: false
  replace: true


jobs:
    build:
      runs-on: ubuntu-20.04

      steps:
        - name: 获取本仓库源码
          uses: actions/checkout@main
  
        - name: 清理＆配置环境
          run: |
            docker rmi `docker images -q`
            sudo apt update
            sudo apt install unzip libtool-bin curl cmake gperf gawk flex bison nano xxd \
            	fakeroot kmod cpio git python3-docutils gettext automake autopoint \
            	texinfo build-essential help2man pkg-config zlib1g-dev libgmp3-dev \
            	libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget libc-dev-bin
          
        - name: 获取源码
          run: |
              ls
              git clone --depth 1 $repo_url -b $repo_branch opt/rt-n56u
              cd $GITHUB_WORKSPACE/opt/rt-n56u/toolchain-mipsel
              sh dl_toolchain.sh

        - name: 替换config
          if: env.replace == 'true'        
          run: |
              rm -rf $GITHUB_WORKSPACE/opt/rt-n56u/trunk/configs/templates/$config
              mv $GITHUB_WORKSPACE/$config $GITHUB_WORKSPACE/opt/rt-n56u/trunk/configs/templates/$config
              ls $GITHUB_WORKSPACE/opt/rt-n56u/trunk/configs/templates/
              chmod 777 $GITHUB_WORKSPACE/opt/rt-n56u/trunk/configs/templates/$config
              
        - name: 编译固件
          run: |
              cd $GITHUB_WORKSPACE/opt/rt-n56u/trunk
              fakeroot ./build_firmware_modify $model  # 脚本第一个参数为路由型号，在trunk/configs/templates/中    # 编译好的固件在trunk/images里
             
        - name: 移动生成至zhlhlf目录
          run: |
           mkdir zhlhlf
           rm -rf zhlhlf/*           
           mv $GITHUB_WORKSPACE/opt/rt-n56u/trunk/images/*.trx zhlhlf         
                              
        - name: Upload artifact
          uses: actions/upload-artifact@master
          with:
           name: pavadan phicomm k2
           path: zhlhlf/
